/**
 * EXENT Implementation
 * EXtended ENtity Transfer
 *
 * @author Costin Trifan
 * @copyright 2025 Costin Trifan
 * @license MIT
 * @version 1.0.0
 */
let Exent=function(){"use strict";class e{constructor(e){this.text=e,this.pos=0,this.length=e.length}peek(){return this.text[this.pos]}next(){return this.text[this.pos++]}skipWhitespace(){for(;this.pos<this.length;){const e=this.text[this.pos];if(/\s/.test(e))this.pos++;else if("/"===e&&"/"===this.text[this.pos+1])for(this.pos+=2;this.pos<this.length&&"\n"!==this.text[this.pos];)this.pos++;else{if("/"!==e||"*"!==this.text[this.pos+1])break;for(this.pos+=2;this.pos<this.length&&("*"!==this.text[this.pos]||"/"!==this.text[this.pos+1]);)this.pos++;this.pos+=2}}}tokenize(){const e=[];for(;this.pos<this.length&&(this.skipWhitespace(),!(this.pos>=this.length));){const t=this.peek();if("{"===t||"}"===t||"["===t||"]"===t||":"===t||","===t)e.push({type:"punct",value:this.next()});else if('"'===t||"'"===t)e.push({type:"string",value:this.readQuotedString(this.next())});else if("`"===t)e.push({type:"multiline_string",value:this.readMultilineString()});else if("@"===t)e.push({type:"date",value:this.readDate()});else if("&"===t)this.next(),e.push({type:"anchor",value:this.readIdentifier()});else if("*"===t)this.next(),e.push({type:"ref",value:this.readIdentifier()});else{const t=this.readIdentifierOrNumber();"true"===t||"false"===t||"null"===t?e.push({type:"literal",value:"null"===t?null:"true"===t}):t.endsWith("n")&&/^\d+n$/.test(t)?e.push({type:"bigint",value:BigInt(t.slice(0,-1))}):t.endsWith("d")&&/^\d+(\.\d+)?d$/.test(t)?e.push({type:"decimal",value:parseFloat(t.slice(0,-1))}):/^-?\d+(\.\d+)?([eE][+-]?\d+)?$/.test(t)?e.push({type:"number",value:Number(t)}):e.push({type:"identifier",value:t})}}return e}readQuotedString(e){let t="";for(;this.pos<this.length;){const s=this.next();if(s===e)break;if("\\"===s){const e=this.next();switch(e){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"b":t+="\b";break;case"f":t+="\f";break;case"u":t+=String.fromCharCode(parseInt(this.text.substr(this.pos,4),16)),this.pos+=4;break;default:t+=e}}else t+=s}return t}readMultilineString(){this.next();let e="";for(;this.pos<this.length;){const t=this.next();if("`"===t)break;e+=t}return e}readDate(){this.next();let e="";for(;this.pos<this.length&&/[0-9-T:Z.+-]/.test(this.peek());)e+=this.next();const t=new Date(e);if(isNaN(t.getTime()))throw new Error("Invalid date: "+e);return t}readIdentifier(){let e="";for(;this.pos<this.length&&/[a-zA-Z0-9_-]/.test(this.peek());)e+=this.next();return e}readIdentifierOrNumber(){let e="";for(;this.pos<this.length&&/[a-zA-Z0-9._+-]/.test(this.peek());)e+=this.next();return e}}class t{constructor(e,t={}){this.tokens=e,this.pos=0,this.anchors={},this.depth=0,this.maxDepth=t.maxDepth||200}peek(){return this.tokens[this.pos]}next(){return this.tokens[this.pos++]}parse(){const e=this.parseValue();if(this.pos<this.tokens.length)throw new Error("Unexpected token at end of input: "+JSON.stringify(this.peek()));return e}parseValue(){if(this.depth>this.maxDepth)throw new Error("Maximum nesting depth exceeded");let e=null;this.peek()&&"anchor"===this.peek().type&&(e=this.next().value);const t=this.peek();if(!t)throw new Error("Unexpected end of input");let s;switch(t.type){case"punct":if("{"===t.value)s={},e&&(this.anchors[e]=s),this.depth++,this.parseObject(s),this.depth--;else{if("["!==t.value)throw new Error("Unexpected punctuation: "+t.value);s=[],e&&(this.anchors[e]=s),this.depth++,this.parseArray(s),this.depth--}break;case"string":case"multiline_string":case"number":case"bigint":case"decimal":case"date":case"literal":case"identifier":s=this.next().value;break;case"ref":const n=this.next().value;if(!(n in this.anchors))throw new Error("Undefined reference: "+n);s=this.anchors[n];break;default:throw new Error("Unexpected token type: "+t.type)}return e&&(this.anchors[e]=s),s}parseObject(e){for(this.next();this.pos<this.tokens.length;){if(this.skipOptionalCommas(),this.peek()&&"punct"===this.peek().type&&"}"===this.peek().value)return this.next(),e;const t=this.next();if("identifier"!==t.type&&"string"!==t.type&&"literal"!==t.type)throw new Error("Expected identifier or string as object key, got "+JSON.stringify(t));const s=String(t.value),n=this.next();if(!n||"punct"!==n.type||":"!==n.value)throw new Error("Expected ':' after key "+s);if(e[s]=this.parseValue(),this.skipOptionalCommas(),this.peek()&&"punct"===this.peek().type&&"}"===this.peek().value)return this.next(),e}throw new Error("Unterminated object")}parseArray(e){for(this.next();this.pos<this.tokens.length;){if(this.skipOptionalCommas(),this.peek()&&"punct"===this.peek().type&&"]"===this.peek().value)return this.next(),e;if(e.push(this.parseValue()),this.skipOptionalCommas(),this.peek()&&"punct"===this.peek().type&&"]"===this.peek().value)return this.next(),e}throw new Error("Unterminated array")}skipOptionalCommas(){for(;this.peek()&&"punct"===this.peek().type&&","===this.peek().value;)this.next()}}return{parse:function(s,n={}){const i=new e(s).tokenize();return new t(i,n).parse()},stringify:function(e,t=4){const s=new Map,n=new Map;let i=0;!function e(t){if(t&&"object"==typeof t&&!(t instanceof Date)){if(n.has(t))return void(s.has(t)||s.set(t,"a"+i++));if(n.set(t,!0),Array.isArray(t))t.forEach(e);else for(const s in t)e(t[s])}}(e);const r=new Set;return function e(n,i=""){const o=i+("number"==typeof t?" ".repeat(t):t||""),h="number"!=typeof t&&"string"!=typeof t||""===t?" ":"\n";let a="";if(n&&"object"==typeof n&&!(n instanceof Date)&&s.has(n)){if(r.has(n))return"*"+s.get(n);a="&"+s.get(n)+" ",r.add(n)}if(null===n)return a+"null";if("boolean"==typeof n)return a+n.toString();if("number"==typeof n)return a+n.toString();if("bigint"==typeof n)return a+n.toString()+"n";if(n instanceof Date)return a+"@"+n.toISOString();if("string"==typeof n)return n.includes("\n")?a+"`"+n+"`":/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(n)&&!["true","false","null"].includes(n)?a+n:a+'"'+n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';if(Array.isArray(n)){if(0===n.length)return a+"[]";return a+"["+h+n.map((t=>e(t,o))).map((e=>o+e)).join(","+h)+h+i+"]"}if("object"==typeof n){const t=Object.keys(n);if(0===t.length)return a+"{}";return a+"{"+h+t.map((t=>(/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(t)?t:'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"')+": "+e(n[t],o))).map((e=>o+e)).join(","+h)+h+i+"}"}return a+'"'+String(n).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}(e)},pack:function(e){const t=[],s=new Map;let n=0;function i(e){t.push(255&e)}function r(e){i(e>>24),i(e>>16),i(e>>8),i(e)}function o(e){const t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e);for(let e=0;e<8;e++)i(t.getUint8(e))}function h(e){const t=(new TextEncoder).encode(e);r(t.length);for(let e of t)i(e)}return function e(t){if(null!==t){if("object"==typeof t&&!(t instanceof Date)){if(s.has(t))return i(11),void r(s.get(t));s.set(t,n++)}if("boolean"==typeof t)i(t?1:2);else if("number"==typeof t)if(Number.isInteger(t)&&t>=-2147483648&&t<=2147483647){i(3);const e=new DataView(new ArrayBuffer(4));e.setInt32(0,t);for(let t=0;t<4;t++)i(e.getUint8(t))}else i(4),o(t);else if("bigint"==typeof t)i(5),function(e){const t=new DataView(new ArrayBuffer(8));t.setBigInt64(0,e);for(let e=0;e<8;e++)i(t.getUint8(e))}(t);else if(t instanceof Date)i(7),o(t.getTime());else if("string"==typeof t)t.endsWith("d")&&/^\d+(\.\d+)?d$/.test(t)?(i(10),o(parseFloat(t.slice(0,-1)))):(i(6),h(t));else if(Array.isArray(t)){i(8),r(t.length);for(let s of t)e(s)}else if("object"==typeof t){i(9);const s=Object.keys(t);r(s.length);for(let n of s)h(n),e(t[n])}}else i(0)}(e),new Uint8Array(t)},unpack:function(e,t={}){let s=0;const n=[],i=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;const o=t.maxDepth||200;function h(){const e=i.getUint32(s);return s+=4,e}function a(){const e=i.getFloat64(s);return s+=8,e}function p(){const t=h(),n=e.subarray(s,s+t);return s+=t,(new TextDecoder).decode(n)}return function t(){if(r>o)throw new Error("Maximum nesting depth exceeded during unpacking");const u=e[s++];switch(u){case 0:return null;case 1:return!0;case 2:return!1;case 3:return function(){const e=i.getInt32(s);return s+=4,e}();case 4:case 10:return a();case 5:return function(){const e=i.getBigInt64(s);return s+=8,e}();case 6:return p();case 7:return new Date(a());case 11:const e=h();return n[e];case 8:const o=h(),c=[];n.push(c),r++;for(let e=0;e<o;e++)c.push(t());return r--,c;case 9:const f=h(),l={};n.push(l),r++;for(let e=0;e<f;e++){l[p()]=t()}return r--,l;default:throw new Error("Unknown B-EXENT tag: "+u+" at pos "+(s-1))}}()}}}();"undefined"!=typeof module&&module.exports?module.exports=Exent:"undefined"!=typeof window&&(window.Exent=Exent);
